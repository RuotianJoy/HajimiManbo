# 固定传送门系统说明

## 概述

传送门系统为HajimiManbo游戏提供了快速传送功能，提供两个固定位置的传送门。系统生成ID为1和2的两个传送门，分别位于地表洞穴和空岛上，玩家可以在这两个位置之间进行瞬间移动。

## 核心组件

### 1. Portal 类
- **功能**: 表示单个传送门实例
- **特性**:
  - 固定ID（1或2）
  - 位置坐标管理
  - 激活状态控制
  - 创建时间记录

### 2. PortalManager 类
- **功能**: 管理固定传送门的生成
- **特性**:
  - 生成固定的两个传送门
  - 位置有效性检查
  - 世界集成

### 3. PortalRenderer 类
- **功能**: 传送门渲染器
- **特性**:
  - 传送门图像的渲染
  - 处理图片空白区域的裁剪
  - 传送门ID标识的显示

### 4. TileType 枚举扩展
- 新增 `Portal = 16` 类型
- 用于在世界中标识传送门方块

## 主要功能

### 1. 固定传送门生成
```csharp
// 生成所有固定传送门
portalManager.GenerateAllPortals();

// 单独生成地表洞穴传送门（ID: 1）
var cavePortal = portalManager.GenerateCavePortal();

// 单独生成空岛传送门（ID: 2）
var islandPortal = portalManager.GenerateIslandPortal();
```

### 2. 传送门查找
```csharp
// 获取所有传送门
var allPortals = Portal.GetAllPortals();

// 根据ID查找传送门
var cavePortal = Portal.GetPortalById(1);  // 地表洞穴传送门
var islandPortal = Portal.GetPortalById(2); // 空岛传送门

// 获取指定位置的传送门
var portal = portalManager.GetPortalAt(x, y);
```

### 3. 传送门状态检查
```csharp
// 检查传送门是否可用
if (portal.CanTeleport())
{
    // 传送门可用
    Console.WriteLine($"传送门 {portal.Id} 可以使用");
}

// 检查传送门激活状态
if (portal.IsActive)
{
    Console.WriteLine($"传送门 {portal.Id} 已激活");
}
```

### 4. 传送门渲染
```csharp
// 创建传送门渲染器
var renderer = new PortalRenderer(graphicsDevice, portalTexture);

// 渲染传送门
renderer.RenderPortal(spriteBatch, portal.Position, portal.Id, tileSize, camera);

// 获取渲染尺寸信息
var renderSize = PortalRenderer.GetPortalRenderSize(); // 80x96 像素

// 检查传送门是否在屏幕可见范围内
if (PortalRenderer.IsPortalVisible(portal.Position, tileSize, camera, screenBounds))
{
    // 渲染传送门
}
```

## 世界生成集成

传送门系统已集成到世界生成流程中：

1. **生成阶段**: 在矿物生成后、液体生成前执行
2. **数量控制**: 根据世界大小自动确定传送门数量
3. **位置选择**: 自动寻找合适的地表位置
4. **空岛传送门**: 自动在空岛上生成特殊传送门
5. **自动连接**: 生成后自动连接附近的传送门

## 使用示例

### 基本使用
```csharp
// 创建世界生成器
var generator = new WorldGenerator();
var world = generator.Generate(seed, settings);
var portalManager = generator.GetPortalManager();

// 手动创建传送门
var homePortal = portalManager.CreatePortalAt(100, 150, "家园传送门");
var minePortal = portalManager.CreatePortalAt(500, 300, "矿洞传送门");

// 连接传送门
homePortal.LinkToPortal(minePortal);

// 玩家传送
if (homePortal.CanTeleport())
{
    playerPosition = homePortal.TargetPosition.Value;
}
```

### 高级功能
```csharp
// 临时停用传送门
portal.IsActive = false;

// 断开连接
portal.Disconnect();

// 获取传送门信息
Console.WriteLine(portal.ToString());

// 清理所有传送门（重置世界时）
Portal.ClearAllPortals();
```

## 事件系统

PortalManager 提供事件通知：

```csharp
// 传送门创建事件
portalManager.OnPortalCreated += (portal) => {
    Console.WriteLine($"创建了新传送门: {portal.Name}");
};

// 传送门销毁事件
portalManager.OnPortalDestroyed += (portalId) => {
    Console.WriteLine($"传送门 {portalId} 已被销毁");
};
```

## 技术特性

### 唯一ID生成
- 使用静态计数器确保ID唯一性
- 从1开始递增
- 支持世界重置时重新开始

### 位置验证
- 检查边界范围
- 确保下方有固体支撑
- 避免与现有传送门冲突
- 当前位置必须为空气

### 内存管理
- 使用静态字典管理所有传送门
- 支持完全清理
- 自动处理连接关系

### 世界集成
- 在世界中放置Portal类型方块
- 使用Style字段存储传送门变体
- 与现有瓦片系统兼容

## 配置参数

| 参数 | 默认值 | 说明 |
|------|--------|------|
| 传送门数量 | world.Width / 400 | 根据世界大小确定，最少2个 |
| 最小距离 | 150格 | 传送门之间的最小生成距离 |
| 最大连接距离 | 300格 | 自动连接的最大距离 |
| 检测范围 | 2格 | 放置时的冲突检测范围 |

## 注意事项

1. **性能考虑**: 传送门数量应适中，避免过多影响性能
2. **保存加载**: 需要在游戏保存/加载时处理传送门数据
3. **网络同步**: 多人游戏时需要同步传送门状态
4. **视觉效果**: 可以添加传送门的视觉特效和音效
5. **平衡性**: 传送门的便利性需要与游戏平衡性考虑

## 扩展建议

1. **传送门类型**: 可以添加不同类型的传送门（单向、双向、限时等）
2. **传送条件**: 可以添加传送条件（物品消耗、等级限制等）
3. **传送动画**: 添加传送过程的视觉效果
4. **传送历史**: 记录玩家的传送历史
5. **传送门网络**: 支持多点传送网络
6. **权限系统**: 支持传送门的访问权限控制